{% extends "base.html" %}

{% block title %}Gestión de Evaluaciones{% endblock %}

{% block content %}
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-4 align-items-center">
            <div class="col-sm-6">
                <h1 class="m-0 text-gradient">
                    <i class="fas fa-tasks me-2"></i>Gestión de Evaluaciones
                </h1>
            </div>
            <div class="col-sm-6">
                <div class="float-sm-end">
                    <button type="button" class="btn btn-primary btn-dashboard" data-bs-toggle="modal" data-bs-target="#newEvaluationModal">
                        <i class="fas fa-plus-circle me-2"></i>Nueva Evaluación
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <!-- Mensaje informativo permanente -->
        <div class="permanent-alert permanent-alert-info mb-4">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Información:</strong> En esta sección puede gestionar los tipos de evaluación para cada asignatura y período.
            Las evaluaciones definen cómo se calculará la nota final de los estudiantes.
        </div>

        <!-- Filtros -->
        <div class="card dashboard-card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-filter me-2"></i>Filtros
                </h5>
                <form method="GET" action="{{ url_for('admin.evaluations') }}" class="row g-3">
                    <div class="col-md-3">
                        <label for="grade_filter" class="form-label">Grado</label>
                        <select name="grade_id" id="grade_filter" class="form-select">
                            <option value="">Todos</option>
                            {% for grade in grades %}
                                <option value="{{ grade.id }}" {% if request.args.get('grade_id')|int == grade.id %}selected{% endif %}>
                                    {{ grade.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="section_filter" class="form-label">Sección</label>
                        <select name="section_id" id="section_filter" class="form-select">
                            <option value="">Todas</option>
                            {% for grade in grades %}
                                <optgroup label="{{ grade.name }}">
                                    {% for section in grade.sections %}
                                        <option value="{{ section.id }}" {% if request.args.get('section_id')|int == section.id %}selected{% endif %}>
                                            {{ section.name }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="subject_filter" class="form-label">Asignatura</label>
                        <select name="subject_id" id="subject_filter" class="form-select">
                            <option value="">Todas</option>
                            {% for subject in subjects %}
                                <option value="{{ subject.id }}" {% if request.args.get('subject_id')|int == subject.id %}selected{% endif %}>
                                    {{ subject.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="period_filter" class="form-label">Período</label>
                        <select name="period_id" id="period_filter" class="form-select">
                            <option value="">Todos</option>
                            {% for year in academic_years %}
                                <optgroup label="{{ year.name }}">
                                    {% for period in year.periods %}
                                        <option value="{{ period.id }}" {% if request.args.get('period_id')|int == period.id %}selected{% endif %}>
                                            {{ period.name }}
                                        </option>
                                    {% endfor %}
                                </optgroup>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 d-flex justify-content-end">
                        <div class="d-grid gap-2 d-md-flex">
                            <a href="{{ url_for('admin.evaluations') }}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-undo me-1"></i>Limpiar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>Filtrar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>


        <!-- Tabla de evaluaciones -->
        <!-- Tabla de evaluaciones -->
        <div class="card dashboard-card">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="fas fa-list me-2"></i>Evaluaciones Registradas
                    <small class="text-muted">({{ grade_types|length }} encontradas)</small>
                </h5>

                
                {% if grade_types %}
                    <div class="table-responsive" id="evaluations-table">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Asignatura</th>
                                    <th>Grado/Sección</th>
                                    <th>Profesor</th>
                                    <th>Período</th>
                                    <th>Ponderación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="evaluations-tbody">
                                {% for grade_type in grade_types %}
                                    <tr class="evaluation-row" data-id="{{ grade_type.id }}">
                                        <td>
                                            <div class="fw-semibold">{{ grade_type.name }}</div>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ grade_type.subject.name }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">
                                                {% if grade_type.section %}
                                                    {{ grade_type.section.grade.name }} "{{ grade_type.section.name }}"
                                                {% else %}
                                                    Sin sección asignada
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info text-dark">
                                                {% if grade_type.teacher and grade_type.teacher.user %}
                                                    {{ grade_type.teacher.user.get_full_name() }}
                                                {% else %}
                                                    Sin profesor asignado
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <div>{{ grade_type.period.name }}</div>
                                            <small class="text-muted">{{ grade_type.period.academic_year.name }}</small>
                                        </td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ grade_type.weight }}%;" 
                                                    aria-valuenow="{{ grade_type.weight }}" aria-valuemin="0" aria-valuemax="100">
                                                    {{ grade_type.weight }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-success" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#enterGradesModal{{ grade_type.id }}" 
                                                        title="Calificar">
                                                    <i class="fas fa-clipboard-check"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editEvaluationModal{{ grade_type.id }}" 
                                                        title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteEvaluationModal{{ grade_type.id }}" 
                                                        title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info" id="no-evaluations-alert">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay evaluaciones registradas con los filtros seleccionados.
                    </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>

<!-- Modal para crear nueva evaluación -->
<div class="modal fade" id="newEvaluationModal" tabindex="-1" aria-labelledby="newEvaluationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newEvaluationModalLabel">Nueva Evaluación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="new-evaluation-form" method="POST" action="{{ url_for('admin.new_evaluation') }}">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Nombre de la Evaluación</label>
                            <input type="text" class="form-control" id="name" name="name" placeholder="Ej: Examen Parcial, Tarea 1, etc." required>
                        </div>
                        <div class="col-md-6">
                            <label for="weight" class="form-label">Ponderación (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="weight" name="weight" min="0.1" max="100" step="0.1" placeholder="Ej: 25" required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="academic_year_id" class="form-label">Año Académico</label>
                            <select class="form-select" id="academic_year_id" name="academic_year_id" required>
                                <option value="" selected disabled>Seleccione un año académico</option>
                                {% for year in academic_years %}
                                    <option value="{{ year.id }}" {% if year.is_active %}selected{% endif %}>
                                        {{ year.name }} {% if year.is_active %}(Activo){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="period_id" class="form-label">Período</label>
                            <select class="form-select" id="period_id" name="period_id" required>
                                <option value="" selected disabled>Seleccione primero un año académico</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="grade_id" class="form-label">Grado</label>
                            <select class="form-select" id="grade_id" name="grade_id" required>
                                <option value="" selected disabled>Seleccione un grado</option>
                                {% for grade in grades %}
                                    <option value="{{ grade.id }}">{{ grade.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="section_id" class="form-label">Sección</label>
                            <select class="form-select" id="section_id" name="section_id" required>
                                <option value="" selected disabled>Seleccione primero un grado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="subject_id" class="form-label">Asignatura</label>
                            <select class="form-select" id="subject_id" name="subject_id" required>
                                <option value="" selected disabled>Seleccione primero una sección</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="teacher_id" class="form-label">Profesor</label>
                            <select class="form-select" id="teacher_id" name="teacher_id" required>
                                <option value="" selected disabled>Seleccione primero una asignatura</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Información de ponderación disponible -->
                    <div class="permaent-alert permanent-alert-info" id="weight-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Seleccione una asignatura y un período para ver la ponderación disponible.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" id="save-evaluation-btn" class="btn btn-primary">Crear Evaluación</button>
                </div>
            </form>
        </div>
    </div>
</div>



<!-- Modales para cada evaluación existente -->
{% for grade_type in grade_types %}
    <!-- Modal para editar evaluación -->
    <div class="modal fade" id="editEvaluationModal{{ grade_type.id }}" tabindex="-1" aria-labelledby="editEvaluationModalLabel{{ grade_type.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEvaluationModalLabel{{ grade_type.id }}">Editar Evaluación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('admin.edit_evaluation', id=grade_type.id) }}">
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="name{{ grade_type.id }}" class="form-label">Nombre de la Evaluación</label>
                                <input type="text" class="form-control" id="name{{ grade_type.id }}" name="name" value="{{ grade_type.name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="weight{{ grade_type.id }}" class="form-label">Ponderación (%)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="weight{{ grade_type.id }}" name="weight" min="0.1" max="100" step="0.1" value="{{ grade_type.weight }}" required>
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información de la evaluación actual -->
                        <div class="permanent-alert permanent-alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Información de la Evaluación</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Asignatura:</strong> {{ grade_type.subject.name }}<br>
                                    <strong>Grado:</strong> {{ grade_type.section.grade.name if grade_type.section else 'Sin asignar' }}<br>
                                    <strong>Sección:</strong> {{ grade_type.section.name if grade_type.section else 'Sin asignar' }}
                                </div>
                                <div class="col-md-6">
                                    <strong>Profesor:</strong> {{ grade_type.teacher.user.get_full_name() if grade_type.teacher and grade_type.teacher.user else 'Sin asignar' }}<br>
                                    <strong>Período:</strong> {{ grade_type.period.name }}<br>
                                    <strong>Año Académico:</strong> {{ grade_type.period.academic_year.name }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="permanent-alert permanent-alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Nota:</strong> No se pueden modificar la asignatura, el grado, la sección, el profesor ni el período de una evaluación existente.
                            Si necesita cambiar estos datos, elimine esta evaluación y cree una nueva.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para eliminar evaluación -->
    <div class="modal fade" id="deleteEvaluationModal{{ grade_type.id }}" tabindex="-1" aria-labelledby="deleteEvaluationModalLabel{{ grade_type.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteEvaluationModalLabel{{ grade_type.id }}">Eliminar Evaluación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea eliminar la evaluación <strong>{{ grade_type.name }}</strong> de la asignatura <strong>{{ grade_type.subject.name }}</strong>?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Esta acción no se puede deshacer y eliminará todas las calificaciones asociadas a esta evaluación.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <form action="{{ url_for('admin.delete_evaluation', id=grade_type.id) }}" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para introducir calificaciones -->
    <div class="modal fade" id="enterGradesModal{{ grade_type.id }}" tabindex="-1" aria-labelledby="enterGradesModalLabel{{ grade_type.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="enterGradesModalLabel{{ grade_type.id }}">
                        Calificaciones - {{ grade_type.name }} - {{ grade_type.subject.name }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('admin.enter_grades', grade_type_id=grade_type.id) }}">
                    <div class="modal-body">
                        {% if grade_type.section %}
                            {% set students_query = grade_type.section.students.filter_by(is_active=True) %}
                            {% set students = students_query.order_by('last_name', 'first_name').all() %}
                            
                            {% if students %}
                                <div class="permanent-alert permanent-alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Introduzca las calificaciones para <strong>{{ grade_type.name }}</strong> de la asignatura <strong>{{ grade_type.subject.name }}</strong>
                                    en la sección <strong>{{ grade_type.section.grade.name }} "{{ grade_type.section.name }}"</strong>.
                                    <br>
                                    <small>Las calificaciones deben estar entre 01 y 20. Use "NP" para indicar que el estudiante no presentó (equivale a 0).</small>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Estudiante</th>
                                                <th>ID</th>
                                                <th>Calificación</th>
                                                <th>Comentarios</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for student in students %}
                                                {% set existing_grade = student.student_grades.filter_by(grade_type_id=grade_type.id).first() %}
                                                <tr>
                                                    <td>{{ loop.index }}</td>
                                                    <td>{{ student.last_name }}, {{ student.first_name }}</td>
                                                    <td>{{ student.student_id }}</td>
                                                    <td width="150">
                                                        <div class="input-group">
                                                            <input type="text" 
                                                                class="form-control grade-input" 
                                                                name="grade_{{ student.id }}" 
                                                                value="{% if existing_grade %}{% if existing_grade.value == 0 %}NP{% else %}{{ '%02d'|format(existing_grade.value|int) }}{% endif %}{% endif %}"
                                                                placeholder="01-20 / NP"
                                                                pattern="^(NP|0[1-9]|1[0-9]|20)$"
                                                                title="Ingrese un valor entre 01 y 20, o NP para No Presentó">
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <input type="text" 
                                                            class="form-control" 
                                                            name="comment_{{ student.id }}" 
                                                            value="{% if existing_grade %}{{ existing_grade.comments or '' }}{% endif %}"
                                                            placeholder="Opcional">
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No hay estudiantes registrados en esta sección.
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Esta evaluación no tiene una sección asignada. Por favor, asigne una sección a esta evaluación primero.
                            </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        {% if grade_type.section and students %}
                            <button type="submit" class="btn btn-primary">Guardar Calificaciones</button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endfor %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
        console.log('=== DEBUG EVALUACIONES ===');
    console.log('Evaluaciones en el DOM:', $('.evaluation-row').length);
    console.log('Tabla visible:', $('#evaluations-table').is(':visible'));
    console.log('Alert "no evaluaciones" visible:', $('#no-evaluations-alert').is(':visible'));
    $('.evaluation-row').length;
    console.log('Tabla visible:', $('#evaluations-table').is(':visible'));

    // Forzar visibilidad de todas las filas
    $('.evaluation-row').show();
    $('#evaluations-table').show();
    
    // Mostrar debug info temporalmente
    $('#debug-info').show();
    
    // Debug: mostrar/ocultar con tecla D
    $(document).keydown(function(e) {
        if (e.key === 'd' || e.key === 'D') {
            $('#debug-info').toggle();
            console.log('=== ESTADO ACTUAL ===');
            console.log('Evaluaciones visibles:', $('.evaluation-row:visible').length);
            console.log('Evaluaciones totales:', $('.evaluation-row').length);
            console.log('Tabla container visible:', $('#evaluations-table').is(':visible'));
        }
    });
    
    // Verificar si hay CSS que esté ocultando elementos
    setTimeout(function() {
        $('.evaluation-row').each(function(index) {
            const $row = $(this);
            const isVisible = $row.is(':visible');
            const display = $row.css('display');
            const visibility = $row.css('visibility');
            const opacity = $row.css('opacity');
            
            if (!isVisible) {
                console.log(`Fila ${index} oculta:`, {
                    display: display,
                    visibility: visibility,
                    opacity: opacity,
                    id: $row.data('id')
                });
            }
        });
    }, 1000);
    
    console.log('Sistema de gestión de evaluaciones inicializado');
    console.log('Sistema de gestión de evaluaciones inicializado');
    
    // Funciones para cargar datos dinámicamente en el orden correcto
    function loadPeriods() {
        const yearId = $('#academic_year_id').val();
        const periodSelect = $('#period_id');
        
        if (!yearId) {
            periodSelect.html('<option value="">Seleccione primero un año académico</option>').prop('disabled', true);
            return;
        }
        
        periodSelect.html('<option value="">Cargando períodos...</option>').prop('disabled', true);
        
        $.get(`/admin/api/academic-year/${yearId}/periods`)
            .done(function(data) {
                periodSelect.html('<option value="">Seleccione un período</option>');
                data.periods.forEach(function(period) {
                    periodSelect.append(`<option value="${period.id}">${period.name}</option>`);
                });
                periodSelect.prop('disabled', false);
            })
            .fail(function() {
                periodSelect.html('<option value="">Error al cargar períodos</option>');
            });
    }
    
    function loadSections() {
        const gradeId = $('#grade_id').val();
        const sectionSelect = $('#section_id');
        
        if (!gradeId) {
            sectionSelect.html('<option value="">Seleccione primero un grado</option>').prop('disabled', true);
            return;
        }
        
        sectionSelect.html('<option value="">Cargando secciones...</option>').prop('disabled', true);
        
        $.get(`/admin/api/grade/${gradeId}/sections`)
            .done(function(data) {
                sectionSelect.html('<option value="">Seleccione una sección</option>');
                data.sections.forEach(function(section) {
                    sectionSelect.append(`<option value="${section.id}">${section.name}</option>`);
                });
                sectionSelect.prop('disabled', false);
            })
            .fail(function() {
                sectionSelect.html('<option value="">Error al cargar secciones</option>');
            });
    }
    
    function loadSubjects() {
        const sectionId = $('#section_id').val();
        const subjectSelect = $('#subject_id');
        
        if (!sectionId) {
            subjectSelect.html('<option value="">Seleccione primero una sección</option>').prop('disabled', true);
            return;
        }
        
        subjectSelect.html('<option value="">Cargando asignaturas...</option>').prop('disabled', true);
        
        $.get(`/admin/api/section/${sectionId}/subjects`)
            .done(function(data) {
                subjectSelect.html('<option value="">Seleccione una asignatura</option>');
                data.subjects.forEach(function(subject) {
                    subjectSelect.append(`<option value="${subject.id}">${subject.name} (${subject.code})</option>`);
                });
                subjectSelect.prop('disabled', false);
            })
            .fail(function() {
                subjectSelect.html('<option value="">Error al cargar asignaturas</option>');
            });
    }
    
    function loadTeachers() {
        const sectionId = $('#section_id').val();
        const subjectId = $('#subject_id').val();
        const teacherSelect = $('#teacher_id');
        
        if (!sectionId || !subjectId) {
            teacherSelect.html('<option value="">Seleccione primero sección y asignatura</option>').prop('disabled', true);
            return;
        }
        
        teacherSelect.html('<option value="">Cargando profesores...</option>').prop('disabled', true);
        
        $.get(`/admin/api/section/${sectionId}/subject/${subjectId}/teachers`)
            .done(function(data) {
                teacherSelect.html('<option value="">Seleccione un profesor</option>');
                if (data.teachers.length === 0) {
                    teacherSelect.append('<option value="" disabled>No hay profesores asignados</option>');
                } else {
                    data.teachers.forEach(function(teacher) {
                        teacherSelect.append(`<option value="${teacher.id}">${teacher.name}</option>`);
                    });
                }
                teacherSelect.prop('disabled', false);
            })
            .fail(function() {
                teacherSelect.html('<option value="">Error al cargar profesores</option>');
            });
    }
    
    function loadAvailableWeight() {
        const subjectId = $('#subject_id').val();
        const periodId = $('#period_id').val();
        const sectionId = $('#section_id').val();
        const teacherId = $('#teacher_id').val();
        const weightInfo = $('#weight-info');
        
        if (!subjectId || !periodId) {
            weightInfo.html('<i class="fas fa-info-circle me-2"></i>Seleccione una asignatura y un período para ver la ponderación disponible.');
            return;
        }
        
        weightInfo.html('<i class="fas fa-spinner fa-spin me-2"></i>Calculando ponderación disponible...');
        
        let url = `/admin/api/subject/${subjectId}/period/${periodId}/available-weight`;
        const params = new URLSearchParams();
        if (sectionId) params.append('section_id', sectionId);
        if (teacherId) params.append('teacher_id', teacherId);
        if (params.toString()) url += `?${params.toString()}`;
        
        $.get(url)
            .done(function(data) {
                const availableWeight = data.available_weight.toFixed(1);
                const totalWeight = data.total_weight.toFixed(1);
                
                let filterInfo = '';
                if (data.filter_applied) {
                    filterInfo = '<div class="mt-2 small text-muted">';
                    if (data.filter_applied.section_id && data.filter_applied.teacher_id) {
                        filterInfo += 'Mostrando ponderación específica para la sección y profesor seleccionados.';
                    } else if (data.filter_applied.section_id) {
                        filterInfo += 'Mostrando ponderación para la sección seleccionada.';
                    } else if (data.filter_applied.teacher_id) {
                        filterInfo += 'Mostrando ponderación para el profesor seleccionado.';
                    }
                    filterInfo += '</div>';
                }
                
                if (availableWeight <= 0) {
                    weightInfo.html(`
                        <i class="fas fa-exclamation-circle me-2 text-danger"></i>
                        <strong class="text-danger">No hay ponderación disponible.</strong>
                        Ya se ha asignado el 100% (${totalWeight}%) de la ponderación.
                        ${filterInfo}
                    `);
                    $('#save-evaluation-btn').prop('disabled', true);
                } else {
                    weightInfo.html(`
                        <i class="fas fa-check-circle me-2 text-success"></i>
                        <strong>Ponderación disponible: ${availableWeight}%</strong>
                        (Asignado: ${totalWeight}%)
                        ${filterInfo}
                    `);
                    
                    if (data.evaluations && data.evaluations.length > 0) {
                        let evaluationsHtml = '<div class="mt-3"><strong>Evaluaciones existentes:</strong><ul class="list-group list-group-flush mt-2">';
                        data.evaluations.forEach(function(eval) {
                            evaluationsHtml += `<li class="list-group-item d-flex justify-content-between align-items-center py-2">${eval.name}<span class="badge bg-primary rounded-pill">${eval.weight}%</span></li>`;
                        });
                        evaluationsHtml += '</ul></div>';
                        weightInfo.append(evaluationsHtml);
                    }
                    
                    $('#save-evaluation-btn').prop('disabled', false);
                    $('#weight').attr('max', availableWeight);
                    
                    if (parseFloat($('#weight').val()) > availableWeight) {
                        $('#weight').val(availableWeight);
                    }
                }
            })
            .fail(function() {
                weightInfo.html('<i class="fas fa-exclamation-circle me-2 text-warning"></i>Error al calcular la ponderación disponible.');
            });
    }
    
    // Eventos para los selectores en el orden correcto
    $('#academic_year_id').change(function() {
        loadPeriods();
        $('#period_id, #subject_id, #teacher_id').val('').prop('disabled', true);
        $('#weight-info').html('<i class="fas fa-info-circle me-2"></i>Seleccione una asignatura y un período para ver la ponderación disponible.');
    });
    
    $('#period_id').change(function() {
        loadAvailableWeight();
    });
    
    $('#grade_id').change(function() {
        loadSections();
        $('#section_id, #subject_id, #teacher_id').val('').prop('disabled', true);
    });
    
    $('#section_id').change(function() {
        loadSubjects();
        $('#subject_id, #teacher_id').val('').prop('disabled', true);
    });
    
    $('#subject_id').change(function() {
        loadTeachers();
        loadAvailableWeight();
        $('#teacher_id').val('');
    });
    
    $('#teacher_id').change(function() {
        loadAvailableWeight();
    });
    
    // Inicializar cuando se abre el modal
    $('#newEvaluationModal').on('show.bs.modal', function() {
        // Resetear formulario
        $('#new-evaluation-form')[0].reset();
        $('.form-control, .form-select').removeClass('is-valid is-invalid');
        
        // Cargar períodos si hay un año seleccionado
        if ($('#academic_year_id').val()) {
            loadPeriods();
        }
        
        // Resetear información de peso
        $('#weight-info').html('<i class="fas fa-info-circle me-2"></i>Seleccione una asignatura y un período para ver la ponderación disponible.');
        $('#save-evaluation-btn').prop('disabled', false);
    });
    
    // Validación de calificaciones
    $(document).on('input', '.grade-input', function() {
        let value = $(this).val().toUpperCase().trim();
        
        $(this).removeClass('is-valid is-invalid');
        
        if (value === '') {
            return;
        }
        
        if (value === 'NP') {
            $(this).val('NP').addClass('is-valid');
        } else {
            value = value.replace(/[^0-9]/g, '');
            
            if (value !== '') {
                let numValue = parseInt(value);
                
                if (numValue >= 1 && numValue <= 20) {
                    $(this).val(('0' + numValue).slice(-2)).addClass('is-valid');
                } else {
                    $(this).addClass('is-invalid');
                }
            } else {
                $(this).val('');
            }
        }
    });
    
    // Navegación con teclado en inputs de calificaciones
    $(document).on('keydown', '.grade-input', function(e) {
        if (e.key === 'Enter' || e.key === 'ArrowDown') {
            e.preventDefault();
            const currentRow = $(this).closest('tr');
            const nextRow = currentRow.next('tr');
            if (nextRow.length) {
                const nextInput = nextRow.find('.grade-input');
                if (nextInput.length) {
                    nextInput.focus().select();
                }
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const currentRow = $(this).closest('tr');
            const prevRow = currentRow.prev('tr');
            if (prevRow.length) {
                const prevInput = prevRow.find('.grade-input');
                if (prevInput.length) {
                    prevInput.focus().select();
                }
            }
        }
    });
    
    // Resaltar filas al enfocar inputs
    $(document).on('focus', '.grade-input', function() {
        $(this).closest('tr').addClass('table-active');
    });
    
    $(document).on('blur', '.grade-input', function() {
        $(this).closest('tr').removeClass('table-active');
    });
    
    // Validación del formulario de nueva evaluación
    $('#new-evaluation-form').on('submit', function(e) {
        const requiredFields = ['name', 'weight', 'academic_year_id', 'period_id', 'grade_id', 'section_id', 'subject_id', 'teacher_id'];
        let isValid = true;
        
        requiredFields.forEach(function(fieldName) {
            const field = $('#' + fieldName);
            if (field.length && !field.val()) {
                field.addClass('is-invalid');
                isValid = false;
            } else if (field.length) {
                field.removeClass('is-invalid');
            }
        });
        
        const weightField = $('#weight');
        if (weightField.length) {
            const weight = parseFloat(weightField.val());
            const maxWeight = parseFloat(weightField.attr('max')) || 100;
            if (weight <= 0 || weight > maxWeight) {
                weightField.addClass('is-invalid');
                isValid = false;
                if (weight > maxWeight) {
                    alert(`El peso no puede ser mayor que ${maxWeight}%`);
                }
            }
        }
        
        if (!isValid) {
            e.preventDefault();
            alert('Por favor, complete todos los campos requeridos correctamente.');
            return false;
        }
    });
    
    // Validación de formularios de calificaciones
    $('form[action*="enter_grades"]').on('submit', function(e) {
        const form = $(this);
        const gradeInputs = form.find('.grade-input');
        let hasChanges = false;
        let invalidGrades = [];
        
        gradeInputs.each(function() {
            const value = $(this).val().trim().toUpperCase();
            const studentRow = $(this).closest('tr');
            const studentName = studentRow.find('td:nth-child(2)').text().trim();
            
            if (value) {
                hasChanges = true;
                if (value !== 'NP') {
                    const numValue = parseInt(value);
                    if (isNaN(numValue) || numValue < 1 || numValue > 20) {
                        invalidGrades.push(studentName);
                    }
                }
            }
        });
        
        if (invalidGrades.length > 0) {
            e.preventDefault();
            alert('Las siguientes calificaciones son inválidas:\n' + invalidGrades.join('\n') + '\n\nPor favor, corrija las calificaciones antes de continuar.');
            return false;
        }
        
        if (!hasChanges) {
            if (!confirm('No se han ingresado calificaciones. ¿Desea continuar?')) {
                e.preventDefault();
                return false;
            }
        }
    });
    
    // Confirmar eliminación de evaluaciones
    $('.btn-danger[type="submit"]').on('click', function(e) {
        if (!confirm('¿Está completamente seguro de que desea eliminar esta evaluación? Esta acción no se puede deshacer.')) {
            e.preventDefault();
            return false;
        }
    });
    
    // Advertencia antes de salir si hay cambios sin guardar
    let hasUnsavedChanges = false;
    
    $(document).on('input change', '.grade-input, input[name*="comment_"], #new-evaluation-form input, #new-evaluation-form select', function() {
        hasUnsavedChanges = true;
    });
    
    $('form').on('submit', function() {
        hasUnsavedChanges = false;
    });
    
    $(window).on('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            const message = 'Tiene cambios sin guardar. ¿Está seguro de que desea salir?';
            e.originalEvent.returnValue = message;
            return message;
        }
    });
    
    // Inicializar tooltips
    $('[data-bs-toggle="tooltip"], [title]').each(function() {
        new bootstrap.Tooltip(this);
    });
    
    // Cargar períodos inicialmente si hay un año académico seleccionado
    if ($('#academic_year_id').val()) {
        loadPeriods();
    }
    
    console.log('Sistema de gestión de evaluaciones inicializado correctamente.');
});
</script>
{% endblock %}
